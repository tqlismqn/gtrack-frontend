<app-edit-form
  #editFormComponent
  (submit$)="onSubmit()"
  formTitle="Create Customer"
  [disableGrid]="true"
  [history]="item()?.history"
  [module]="module"
>
  <div class="customers-edit-form">
    <div class="left-block">
      <div class="row row--actions row--2">
        <mat-form-field *ngIf="form.controls.internal_company_id as control">
          <mat-label>Company ID</mat-label>
          <input readonly matInput [formControl]="control" />
        </mat-form-field>
        <button color="primary" mat-icon-button type="button">
          <mat-icon fontIcon="file_copy"></mat-icon>
        </button>
      </div>

      <div class="row row--actions row--2">
        <mat-form-field *ngIf="form.controls.company_name as control">
          <mat-label>Company Name</mat-label>
          <input matInput [formControl]="control" />
          <mat-error *ngIf="control.hasError('required')"
            >This field is <b>required</b></mat-error
          >
        </mat-form-field>
        <button color="primary" mat-icon-button type="button">
          <mat-icon fontIcon="file_copy"></mat-icon>
        </button>
      </div>

      <div class="row row--actions">
        <mat-form-field *ngIf="form.controls.vat_id as control">
          <mat-label>VAT ID no.</mat-label>
          <input matInput [formControl]="control" />
          <mat-error *ngIf="control.hasError('required')"
            >This field is <b>required</b></mat-error
          >
        </mat-form-field>
        <button color="primary" mat-icon-button type="button">
          <mat-icon fontIcon="file_copy"></mat-icon>
        </button>
        <button type="button" color="accent" mat-flat-button>Check</button>
      </div>

      <mat-form-field *ngIf="form.controls.contact_name as control">
        <mat-label>Contact person</mat-label>
        <input matInput [formControl]="control" />
        <mat-error *ngIf="control.hasError('required')"
          >This field is <b>required</b></mat-error
        >
      </mat-form-field>

      <div class="row row--actions">
        <mat-form-field *ngIf="form.controls.contact_phone as control">
          <mat-label>Contact Phone</mat-label>
          <input matInput [formControl]="control" />
          <mat-error *ngIf="control.hasError('required')"
            >This field is <b>required</b></mat-error
          >
        </mat-form-field>
        <button color="primary" mat-icon-button type="button">
          <mat-icon fontIcon="file_copy"></mat-icon>
        </button>
        <button color="primary" mat-icon-button type="button">
          <mat-icon fontIcon="phone"></mat-icon>
        </button>
      </div>

      <div class="row row--actions">
        <mat-form-field *ngIf="form.controls.contact_email as control">
          <mat-label>Main contact Email</mat-label>
          <input matInput [formControl]="control" />
          <mat-error *ngIf="control.hasError('required')"
            >This field is <b>required</b></mat-error
          >
          <mat-error *ngIf="control.hasError('email')"
            >Enter valid email</mat-error
          >
        </mat-form-field>
        <button color="primary" mat-icon-button type="button">
          <mat-icon fontIcon="file_copy"></mat-icon>
        </button>
      </div>

      <div class="row row--actions">
        <mat-form-field *ngIf="form.controls.accounting_email as control">
          <mat-label>Email for accounting department</mat-label>
          <input matInput [formControl]="control" />
          <mat-error *ngIf="control.hasError('required')"
            >This field is <b>required</b></mat-error
          >
          <mat-error *ngIf="control.hasError('pattern')"
            >Enter valid emails</mat-error
          >
        </mat-form-field>
        <button color="primary" mat-icon-button type="button">
          <mat-icon fontIcon="file_copy"></mat-icon>
        </button>
      </div>

      <div class="row">
        <mat-form-field *ngIf="form.controls.nation as control">
          <mat-label>Nation</mat-label>
          <mat-select [formControl]="control">
            <mat-option *ngFor="let code of countries" [value]="code">{{
              code
            }}</mat-option>
          </mat-select>
          <mat-error *ngIf="control.hasError('required')"
            >This field is <b>required</b></mat-error
          >
        </mat-form-field>
        <mat-form-field *ngIf="form.controls.zip as control">
          <mat-label>Zip Code</mat-label>
          <input matInput [formControl]="control" />
          <mat-error *ngIf="control.hasError('required')"
            >This field is <b>required</b></mat-error
          >
        </mat-form-field>
        <mat-form-field *ngIf="form.controls.city as control">
          <mat-label>City</mat-label>
          <input matInput [formControl]="control" />
          <mat-error *ngIf="control.hasError('required')"
            >This field is <b>required</b></mat-error
          >
        </mat-form-field>
      </div>

      <mat-form-field *ngIf="form.controls.street as control">
        <mat-label>Street</mat-label>
        <input matInput [formControl]="control" />
        <mat-error *ngIf="control.hasError('required')"
          >This field is <b>required</b></mat-error
        >
      </mat-form-field>

      <div class="row">
        <mat-checkbox [formControl]="form.controls.is_client"
        >Is client</mat-checkbox
        >
        <mat-checkbox [formControl]="form.controls.is_contractor"
        >Is contractor</mat-checkbox
        >
      </div>

      <h2>Payment Conditions</h2>

      <mat-form-field *ngIf="form.controls.terms_of_payment as control">
        <mat-label>Terms of Payment</mat-label>
        <mat-select [formControl]="control">
          <mat-option *ngFor="let term of termsOfPayment" [value]="term.id">
            {{ term.name }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="control.hasError('required')"
          >This field is <b>required</b></mat-error
        >
      </mat-form-field>

      <mat-form-field *ngIf="form.controls.pallet_balance as control">
        <mat-label>Pallet balance</mat-label>
        <input matInput [formControl]="control" type="number" min="0" />
        <mat-error *ngIf="control.hasError('required')"
          >This field is <b>required</b></mat-error
        >
      </mat-form-field>

      <h2>Credit limit</h2>

      <div class="grid">
        <mat-form-field *ngIf="form.controls.insurance_credit_limit as control">
          <mat-label>Insurance Credit Limit</mat-label>
          <input
            matInput
            [formControl]="control"
            type="number"
            min="0"
            [readonly]="!ableToEditLimits"
          />
          <mat-error *ngIf="control.hasError('required')"
            >This field is <b>required</b></mat-error
          >
        </mat-form-field>
        <mat-form-field
          *ngIf="form.controls.available_insurance_limit as control"
        >
          <mat-label>Available Insurance Limit</mat-label>
          <input
            matInput
            [formControl]="control"
            type="number"
            min="0"
            readonly
          />
          <mat-error *ngIf="control.hasError('required')"
            >This field is <b>required</b></mat-error
          >
        </mat-form-field>
        <mat-form-field *ngIf="form.controls.internal_credit_limit as control">
          <mat-label>Internal credit limit</mat-label>
          <input
            matInput
            [formControl]="control"
            type="number"
            min="0"
            [readonly]="!ableToEditLimits"
          />
          <mat-error *ngIf="control.hasError('required')"
            >This field is <b>required</b></mat-error
          >
        </mat-form-field>
        <mat-form-field
          *ngIf="form.controls.total_available_credit_limit as control"
        >
          <mat-label>Total Available Credit Limit</mat-label>
          <input
            matInput
            [formControl]="control"
            type="number"
            min="0"
            readonly
          />
          <mat-error *ngIf="control.hasError('required')"
            >This field is <b>required</b></mat-error
          >
        </mat-form-field>
      </div>

      <div class="banking-details" *ngIf="form.controls.is_contractor.value">
        <h2>Banking details</h2>

        <app-customers-bank-collection
          *ngIf="firstBank"
          [formGroup]="firstBank"
          [banks]="bankCollections()"
        ></app-customers-bank-collection>

        <button
          mat-flat-button
          color="accent"
          (click)="addBank()"
          type="button"
          class="banking-details__add"
        >
          Add New
        </button>

        <div class="banking-details__other">
          <div
            class="banking-details__other__item"
            *ngFor="let form of otherBanks; let i = index"
          >
            <h3>Bank {{ i + 1 }}</h3>
            <app-customers-bank-collection
              [formGroup]="form"
              [banks]="bankCollections()"
            ></app-customers-bank-collection>
          </div>
        </div>
      </div>
    </div>
    <div class="right-block">
      <mat-form-field *ngIf="form.controls.remark as control">
        <mat-label>Remark</mat-label>
        <textarea matInput [formControl]="control"></textarea>
      </mat-form-field>

      <div
        class="upload-files-wp"
        [class]="{ inactive: type === 'create' }"
        [matTooltip]="
          type === 'create'
            ? 'Documents is inactive until the Customer is created'
            : ''
        "
        matTooltipPosition="right"
      >
        <h2>Documents</h2>
        <input
          hidden
          type="file"
          #file
          [multiple]="true"
          (change)="onFilesChange(file.files)"
        />
        <div
          class="upload-files"
          [class]="{ dragging: isDragging }"
          (dragover)="isDragging = true; $event.preventDefault()"
          (dragleave)="isDragging = false; $event.preventDefault()"
          (drop)="isDragging = false; $event.preventDefault(); drop($event)"
        >
          <ng-container *ngIf="form.controls.documents?.value as documents">
            <div
              *ngFor="let doc of documents; let i = index"
              class="upload-files__file"
            >
              <div class="upload-files__file__name">{{ doc.name }}</div>
              <div class="upload-files__file__date" *ngIf="doc.lastModified">
                {{ doc.lastModified | date: "dd/MM/YYYY" }}
              </div>
              <button
                color="primary"
                mat-icon-button
                type="button"
                (click)="downloadFile(doc)"
              >
                <mat-icon fontIcon="download"></mat-icon>
              </button>
              <button
                color="warn"
                mat-icon-button
                type="button"
                (click)="removeFile(doc)"
              >
                <mat-icon fontIcon="delete"></mat-icon>
              </button>
            </div>
          </ng-container>
        </div>
        <button
          class="upload-files__upload"
          mat-flat-button
          color="accent"
          (click)="file.click()"
          type="button"
        >
          Upload File
        </button>
      </div>

      <div
        class="raiting"
        [class]="{ inactive: type === 'create' }"
        [matTooltip]="
          type === 'create'
            ? 'Raiting is inactive until the Customer is created'
            : ''
        "
        matTooltipPosition="right"
      >
        <h2>Raiting</h2>
        <div class="raiting__row">
          <mat-form-field *ngIf="raitingForm.controls.raiting as control">
            <mat-label>Raiting</mat-label>
            <mat-select [formControl]="control" panelClass="raiting__panel">
              <mat-select-trigger>
                <span
                  class="raiting__element"
                  [class]="getRaitingClassName(control.value)"
                >
                </span>
              </mat-select-trigger>
              <mat-option *ngFor="let raiting of raitings" [value]="raiting">
                <span
                  class="raiting__element"
                  [class]="getRaitingClassName(raiting)"
                >
                </span>
              </mat-option>
            </mat-select>
            <mat-error *ngIf="control.hasError('required')"
              >This field is <b>required</b></mat-error
            >
          </mat-form-field>
          <mat-form-field *ngIf="raitingForm.controls.comment as control">
            <mat-label>Raiting description</mat-label>
            <textarea matInput [formControl]="control"></textarea>
            <mat-error *ngIf="control.hasError('required')"
              >This field is <b>required</b></mat-error
            >
          </mat-form-field>
        </div>
        <button
          class="raiting__add"
          type="button"
          mat-flat-button
          color="accent"
          (click)="addRaiting()"
        >
          Add
        </button>

        <ng-container *ngIf="item() as item">
          <h2 *ngIf="item.raiting && item.raiting.length > 0">
            Raiting history
          </h2>
          <div
            class="raiting__table-wp"
            *ngIf="item.raiting && item.raiting.length > 0"
          >
            <table class="raiting__table" mat-table [dataSource]="item.raiting">
              <ng-container matColumnDef="raiting">
                <th mat-header-cell *matHeaderCellDef>Raiting</th>
                <td mat-cell *matCellDef="let element">
                  <span
                    class="raiting__element"
                    [class]="getRaitingClassName(element.raiting)"
                  >
                  </span>
                </td>
              </ng-container>

              <ng-container matColumnDef="user">
                <th mat-header-cell *matHeaderCellDef>User</th>
                <td mat-cell *matCellDef="let element">
                  {{ getUserName(element.user) }}
                </td>
              </ng-container>

              <ng-container matColumnDef="comment">
                <th mat-header-cell *matHeaderCellDef>Comment</th>
                <td mat-cell *matCellDef="let element">
                  {{ element.comment }}
                </td>
              </ng-container>

              <ng-container matColumnDef="date">
                <th mat-header-cell *matHeaderCellDef>Date</th>
                <td mat-cell *matCellDef="let element">
                  {{ element.date | date: "dd/MM/YYYY" }}
                </td>
              </ng-container>

              <tr
                class="raiting__table__header"
                mat-header-row
                *matHeaderRowDef="['raiting', 'user', 'comment', 'date']"
              ></tr>
              <tr
                mat-row
                *matRowDef="
                  let row;
                  columns: ['raiting', 'user', 'comment', 'date']
                "
              ></tr>
            </table>
          </div>
        </ng-container>
      </div>
    </div>
  </div>
</app-edit-form>
